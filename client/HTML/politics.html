<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„åšå®¢</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼ -->
    <link rel="stylesheet" href="/CSS/style.css">
    <link rel="stylesheet" href="/CSS/style_journal.css">
    <!-- å¼•å…¥vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body id="app">
    <header>
        <h1>æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢</h1>
    </header>
    <!-- å˜æ¢ä¸»é¢˜ -->
    <div class="theme-toggle-container">
        <button @click="toggleTheme" class="theme-toggle-btn">
            <span class="theme-icon sun-icon">â˜€ï¸</span>
            <span class="theme-icon moon-icon">ğŸŒ™</span>
        </button>
    </div>

    <nav>
        <div class="nav-container">
            <a href="index.html">é¦–é¡µ</a>
            <a href="journal.html">æ—¥è®°</a>
            <a href="politics.html">æ”¿æ²»</a>
            <a href="growth.html">æˆé•¿</a>
            <a href="notes.html">ç¬”è®°</a>
        </div>
    </nav>

    <div class="journal-container">
        <div class="journal-header">
            <h2>æ”¿æ²»</h2>
            <button @click="createNewArticle" class="new-article-btn">
                æ–°å»ºæ–‡ç« 
            </button>
        </div>

        <div v-if="articles.length === 0" class="empty-state">
            <h3>è¿˜æ²¡æœ‰æ–‡ç« </h3>
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å†™ä½ çš„ç¬¬ä¸€ç¯‡æ–‡ç« å§ï¼</p>
        </div>

        <div v-for="article in articles" :key="article._id" class="article-card">
            <a :href="`/article.html?id=${article._id}`" class="article-title">
                {{ article.title }}
            </a>

            <div class="article-meta">
                <div class="article-info">
                    <span>{{ formatDate(article.createdAt) }}</span>
                    <span class="status-badge" :class="article.published ? 'status-published' : 'status-draft'">
                        {{ article.published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿' }}
                    </span>
                </div>

                <div class="article-actions">
                    <button @click="editArticle(article._id)" class="action-btn edit-btn">
                        âœï¸ ç¼–è¾‘
                    </button>
                    <button v-if="!article.published" @click="publishArticle(article)" class="action-btn publish-btn">
                        ğŸ“¢ å‘å¸ƒ
                    </button>
                    <button v-if="article.published" @click="unpublishArticle(article)"
                        class="action-btn unpublish-btn">
                        ğŸ“ å–æ¶ˆå‘å¸ƒ
                    </button>
                    <button @click="deleteArticle(article)" class="action-btn delete-btn">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åœ¨ journal.html çš„ <script> æ ‡ç­¾ä¸­ï¼Œä¿®æ”¹ä»¥ä¸‹éƒ¨åˆ†ï¼š

            const { createApp } = Vue;

            createApp({
                data() {
                    return {
                        articles: [],
                        change: false,
                        currentCategory: 'æ”¿æ²»' // å›ºå®šå½“å‰é¡µé¢çš„åˆ†ç±»
                    };
                },
                methods: {
                    // è·å–æ–‡ç« åˆ—è¡¨ - åªè·å–å½“å‰åˆ†ç±»çš„æ–‡ç« 
                    async fetchArticles() {
                        try {
                            const response = await axios.get(`/api/articles/all?category=${this.currentCategory}`);
                            this.articles = response.data;
                            console.log(`è·å–åˆ°çš„${this.currentCategory}æ–‡ç« :`, this.articles);
                        } catch (error) {
                            console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                        }
                    },

                    createNewArticle() {
                        // æ–°å»ºæ–‡ç« æ—¶ä¼ é€’å½“å‰åˆ†ç±»
                        window.location.href = `/article.html?edit=true&category=${this.currentCategory}`;
                    },

                    editArticle(id) {
                        window.location.href = `/article.html?id=${id}&edit=true`;
                    },

                    async publishArticle(article) {
                        try {
                            const response = await axios.post(`/api/articles/${article._id}/publish`, {
                                published: true
                            });
                            article.published = response.data.published;
                            console.log('å‘å¸ƒæˆåŠŸ');
                        } catch (error) {
                            console.error('å‘å¸ƒå¤±è´¥:', error);
                            alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    },

                    async unpublishArticle(article) {
                        try {
                            const response = await axios.post(`/api/articles/${article._id}/publish`, {
                                published: false
                            });
                            article.published = response.data.published;
                            console.log('å–æ¶ˆå‘å¸ƒæˆåŠŸ');
                        } catch (error) {
                            console.error('å–æ¶ˆå‘å¸ƒå¤±è´¥:', error);
                            alert('å–æ¶ˆå‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    },

                    async deleteArticle(article) {
                        const userConfirmed = window.confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ç« "${article.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
                        if (!userConfirmed) {
                            return;
                        }

                        try {
                            console.log('æ­£åœ¨åˆ é™¤æ–‡ç« :', article._id);
                            const deleteUrl = `/api/articles/${article._id}`;
                            const response = await axios.delete(deleteUrl);
                            console.log('åˆ é™¤å“åº”:', response.data);

                            // ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤
                            const index = this.articles.findIndex(a => a._id === article._id);
                            if (index > -1) {
                                this.articles.splice(index, 1);
                            }

                            alert('æ–‡ç« åˆ é™¤æˆåŠŸï¼');
                        } catch (error) {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            let errorMessage = 'åˆ é™¤å¤±è´¥: ';
                            if (error.response) {
                                errorMessage += error.response.data?.error || error.response.statusText || 'æœªçŸ¥é”™è¯¯';
                            } else if (error.request) {
                                errorMessage += 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
                            } else {
                                errorMessage += error.message;
                            }
                            alert(errorMessage);
                        }
                    },

                    formatDate(dateString) {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    },

                    toggleTheme() {
                        this.change = !this.change;
                        document.body.classList.toggle("dark");
                    }
                },

                mounted() {
                    // æ¢å¤ä¸»é¢˜çŠ¶æ€
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark') {
                        this.change = true;
                        document.body.classList.add('dark');
                    } else {
                        this.change = false;
                        document.body.classList.remove('dark');
                    }

                    // è·å–æ–‡ç« åˆ—è¡¨
                    this.fetchArticles();
                }
            }).mount('#app');
    </script>
</body>

</html>