<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>我的博客</title>
    <!-- 引入外部样式 -->
    <link rel="stylesheet" href="/CSS/style.css">
    <!-- 引入vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .journal-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .journal-header h2 {
            margin: 0;
            color: #333;
        }

        .new-article-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .new-article-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .article-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.15);
        }

        .article-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .article-title {
            margin: 0 0 10px 0;
            font-size: 22px;
            color: #333;
            text-decoration: none;
            font-weight: 600;
        }

        .article-title:hover {
            color: #667eea;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .article-info {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-published {
            background: #e8f5e8;
            color: #2d7d2d;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .article-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .publish-btn {
            background: #28a745;
            color: white;
        }

        .publish-btn:hover {
            background: #218838;
        }

        .unpublish-btn {
            background: #ffc107;
            color: #212529;
        }

        .unpublish-btn:hover {
            background: #e0a800;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }

        /* 深色主题适配 */
        body.dark .journal-header,
        body.dark .article-card {
            background: #2d3748;
            color: white;
        }

        body.dark .article-title {
            color: white;
        }

        body.dark .article-title:hover {
            color: #667eea;
        }

        body.dark .article-meta {
            border-top-color: #4a5568;
        }

        body.dark .article-info {
            color: #a0aec0;
        }
    </style>
</head>

<body id="app">
    <header>
        <h1>欢迎来到我的博客</h1>
    </header>
    <!-- 变换主题 -->
    <button @click="toggleTheme">{{change?"白色":"黑色"}}主题</button>

    <nav>
        <a href="index.html">首页</a>
        <a href="about.html">关于我</a>
        <a href="journal.html">日记</a>
    </nav>

    <div class="journal-container">
        <div class="journal-header">
            <h2>我的日记</h2>
            <button @click="createNewArticle" class="new-article-btn">
                ✏️ 写新日记
            </button>
        </div>

        <div v-if="articles.length === 0" class="empty-state">
            <h3>还没有日记</h3>
            <p>点击上方按钮开始写你的第一篇日记吧！</p>
        </div>

        <div v-for="article in articles" :key="article._id" class="article-card">
            <a :href="`/article.html?id=${article._id}`" class="article-title">
                {{ article.title }}
            </a>

            <div class="article-meta">
                <div class="article-info">
                    <span>{{ formatDate(article.createdAt) }}</span>
                    <span class="status-badge" :class="article.published ? 'status-published' : 'status-draft'">
                        {{ article.published ? '已发布' : '草稿' }}
                    </span>
                </div>

                <div class="article-actions">
                    <button @click="editArticle(article._id)" class="action-btn edit-btn">
                        ✏️ 编辑
                    </button>
                    <button v-if="!article.published" @click="publishArticle(article)" class="action-btn publish-btn">
                        📢 发布
                    </button>
                    <button v-if="article.published" @click="unpublishArticle(article)"
                        class="action-btn unpublish-btn">
                        📝 取消发布
                    </button>
                    <button @click="deleteArticle(article)" class="action-btn delete-btn">
                        🗑️ 删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    articles: [],
                    change: false
                };
            },
            methods: {
                // 获取文章列表
                async fetchArticles() {
                    try {
                        const response = await axios.get('/api/articles/all?category=日记');
                        this.articles = response.data;
                        console.log('获取到的文章:', this.articles);
                    } catch (error) {
                        console.error('获取文章列表失败:', error);
                    }
                },

                createNewArticle() {
                    window.location.href = '/article.html?edit=true&category=日记';
                },

                editArticle(id) {
                    window.location.href = `/article.html?id=${id}&edit=true`;
                },

                async publishArticle(article) {
                    try {
                        const response = await axios.post(`/api/articles/${article._id}/publish`, {
                            published: true
                        });
                        article.published = response.data.published;
                        console.log('发布成功');
                    } catch (error) {
                        console.error('发布失败:', error);
                        alert('发布失败，请重试');
                    }
                },

                async unpublishArticle(article) {
                    try {
                        const response = await axios.post(`/api/articles/${article._id}/publish`, {
                            published: false
                        });
                        article.published = response.data.published;
                        console.log('取消发布成功');
                    } catch (error) {
                        console.error('取消发布失败:', error);
                        alert('取消发布失败，请重试');
                    }
                },

                // 在 journal.html 的 <script> 标签中，替换 deleteArticle 方法

                async deleteArticle(article) {
                    const userConfirmed = window.confirm(`确定要删除文章"${article.title}"吗？此操作不可恢复。`);
                    if (!userConfirmed) {
                        return;
                    }

                    try {
                        console.log('正在删除文章:', article._id);

                        // 确保URL格式正确
                        const deleteUrl = `/api/articles/${article._id}`;
                        console.log('删除URL:', deleteUrl);

                        const response = await axios.delete(deleteUrl);
                        console.log('删除响应:', response.data);

                        // 从本地数组中移除
                        const index = this.articles.findIndex(a => a._id === article._id);
                        if (index > -1) {
                            this.articles.splice(index, 1);
                        }

                        alert('文章删除成功！');
                    } catch (error) {
                        console.error('删除失败:', error);
                        console.error('错误详情:', error.response?.data);

                        // 更详细的错误信息
                        let errorMessage = '删除失败: ';
                        if (error.response) {
                            errorMessage += error.response.data?.error || error.response.statusText || '未知错误';
                        } else if (error.request) {
                            errorMessage += '网络请求失败，请检查服务器是否运行';
                        } else {
                            errorMessage += error.message;
                        }

                        alert(errorMessage);
                    }
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },

                toggleTheme() {
                    this.change = !this.change;
                    document.body.classList.toggle("dark");
                }
            },

            mounted() {
                this.fetchArticles();
            }
        }).mount('#app');
    </script>
</body>

</html>