<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„åšå®¢</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼ -->
    <link rel="stylesheet" href="/CSS/style.css">
    <!-- å¼•å…¥vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .journal-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .journal-header h2 {
            margin: 0;
            color: #333;
        }

        .new-article-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .new-article-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .article-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.15);
        }

        .article-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .article-title {
            margin: 0 0 10px 0;
            font-size: 22px;
            color: #333;
            text-decoration: none;
            font-weight: 600;
        }

        .article-title:hover {
            color: #667eea;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .article-info {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-published {
            background: #e8f5e8;
            color: #2d7d2d;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .article-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .publish-btn {
            background: #28a745;
            color: white;
        }

        .publish-btn:hover {
            background: #218838;
        }

        .unpublish-btn {
            background: #ffc107;
            color: #212529;
        }

        .unpublish-btn:hover {
            background: #e0a800;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }

        /* æ·±è‰²ä¸»é¢˜é€‚é… */
        body.dark .journal-header,
        body.dark .article-card {
            background: #2d3748;
            color: white;
        }

        body.dark .article-title {
            color: white;
        }

        body.dark .article-title:hover {
            color: #667eea;
        }

        body.dark .article-meta {
            border-top-color: #4a5568;
        }

        body.dark .article-info {
            color: #a0aec0;
        }
    </style>
</head>

<body id="app">
    <header>
        <h1>æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢</h1>
    </header>
    <!-- å˜æ¢ä¸»é¢˜ -->
    <button @click="toggleTheme">{{change?"ç™½è‰²":"é»‘è‰²"}}ä¸»é¢˜</button>

    <nav>
        <a href="index.html">é¦–é¡µ</a>
        <a href="about.html">å…³äºæˆ‘</a>
        <a href="journal.html">æ—¥è®°</a>
    </nav>

    <div class="journal-container">
        <div class="journal-header">
            <h2>æˆ‘çš„æ—¥è®°</h2>
            <button @click="createNewArticle" class="new-article-btn">
                âœï¸ å†™æ–°æ—¥è®°
            </button>
        </div>

        <div v-if="articles.length === 0" class="empty-state">
            <h3>è¿˜æ²¡æœ‰æ—¥è®°</h3>
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å†™ä½ çš„ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼</p>
        </div>

        <div v-for="article in articles" :key="article._id" class="article-card">
            <a :href="`/article.html?id=${article._id}`" class="article-title">
                {{ article.title }}
            </a>

            <div class="article-meta">
                <div class="article-info">
                    <span>{{ formatDate(article.createdAt) }}</span>
                    <span class="status-badge" :class="article.published ? 'status-published' : 'status-draft'">
                        {{ article.published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿' }}
                    </span>
                </div>

                <div class="article-actions">
                    <button @click="editArticle(article._id)" class="action-btn edit-btn">
                        âœï¸ ç¼–è¾‘
                    </button>
                    <button v-if="!article.published" @click="publishArticle(article)" class="action-btn publish-btn">
                        ğŸ“¢ å‘å¸ƒ
                    </button>
                    <button v-if="article.published" @click="unpublishArticle(article)"
                        class="action-btn unpublish-btn">
                        ğŸ“ å–æ¶ˆå‘å¸ƒ
                    </button>
                    <button @click="deleteArticle(article)" class="action-btn delete-btn">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    articles: [],
                    change: false
                };
            },
            methods: {
                // è·å–æ–‡ç« åˆ—è¡¨
                async fetchArticles() {
                    try {
                        const response = await axios.get('/api/articles/all?category=æ—¥è®°');
                        this.articles = response.data;
                        console.log('è·å–åˆ°çš„æ–‡ç« :', this.articles);
                    } catch (error) {
                        console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                    }
                },

                createNewArticle() {
                    window.location.href = '/article.html?edit=true&category=æ—¥è®°';
                },

                editArticle(id) {
                    window.location.href = `/article.html?id=${id}&edit=true`;
                },

                async publishArticle(article) {
                    try {
                        const response = await axios.post(`/api/articles/${article._id}/publish`, {
                            published: true
                        });
                        article.published = response.data.published;
                        console.log('å‘å¸ƒæˆåŠŸ');
                    } catch (error) {
                        console.error('å‘å¸ƒå¤±è´¥:', error);
                        alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                },

                async unpublishArticle(article) {
                    try {
                        const response = await axios.post(`/api/articles/${article._id}/publish`, {
                            published: false
                        });
                        article.published = response.data.published;
                        console.log('å–æ¶ˆå‘å¸ƒæˆåŠŸ');
                    } catch (error) {
                        console.error('å–æ¶ˆå‘å¸ƒå¤±è´¥:', error);
                        alert('å–æ¶ˆå‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                },

                // åœ¨ journal.html çš„ <script> æ ‡ç­¾ä¸­ï¼Œæ›¿æ¢ deleteArticle æ–¹æ³•

                async deleteArticle(article) {
                    const userConfirmed = window.confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ç« "${article.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
                    if (!userConfirmed) {
                        return;
                    }

                    try {
                        console.log('æ­£åœ¨åˆ é™¤æ–‡ç« :', article._id);

                        // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
                        const deleteUrl = `/api/articles/${article._id}`;
                        console.log('åˆ é™¤URL:', deleteUrl);

                        const response = await axios.delete(deleteUrl);
                        console.log('åˆ é™¤å“åº”:', response.data);

                        // ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤
                        const index = this.articles.findIndex(a => a._id === article._id);
                        if (index > -1) {
                            this.articles.splice(index, 1);
                        }

                        alert('æ–‡ç« åˆ é™¤æˆåŠŸï¼');
                    } catch (error) {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data);

                        // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        let errorMessage = 'åˆ é™¤å¤±è´¥: ';
                        if (error.response) {
                            errorMessage += error.response.data?.error || error.response.statusText || 'æœªçŸ¥é”™è¯¯';
                        } else if (error.request) {
                            errorMessage += 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
                        } else {
                            errorMessage += error.message;
                        }

                        alert(errorMessage);
                    }
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },

                toggleTheme() {
                    this.change = !this.change;
                    document.body.classList.toggle("dark");
                }
            },

            mounted() {
                this.fetchArticles();
            }
        }).mount('#app');
    </script>
</body>

</html>